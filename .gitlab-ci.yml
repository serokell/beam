image: nixos/nix:latest

stages:
  - build-base
  - build
  - test

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
  - /builds/tathougies1/beam/.stack/
  - /root/.stack
  - .stack-work/
  - /nix

build beam core:
  stage: build-base
  script: nix-shell --command "stack build --system-ghc --nix beam-core beam-migrate --flag beam-core:werror --flag beam-migrate:werror"

build beam sqlite:
  stage: build
  dependencies:
    - "build beam core"
  script: nix-shell --command "stack build --system-ghc beam-sqlite --flag beam-sqlite:werror"

build beam postgres:
  stage: build
  dependencies:
    - "build beam core"
  script: nix-shell --command "stack build --system-ghc beam-postgres --flag beam-postgres:werror"

test beam-core:
  stage: test
  dependencies:
    - "build beam core"
  script: nix-shell --command "stack test --system-ghc --nix beam-core --flag beam-core:werror"

test beam-postgres:
  stage: test
  dependencies:
    - "build beam postgres"
  script: mkdir /var/lib/postgres && chown postgres /var/lib/postgres && mkdir /var/lib/postgres/.stack && nix-shell --command "su -c 'stack test --system-ghc --nix beam-postgres --flag beam-postgres:werror' postgres"
